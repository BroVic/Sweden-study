---
title: "Output of multivariate analysis"
author: "Victor Ordu"
date: "22 May 2016"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Loading the dataset and some required R packages
```{r, warning=FALSE}
library(tidyr)
library(MASS)
library(Hmisc)

data<- readRDS("clean_x.rds")
mydata <- data[, c(2, 5, 6, 12, 13, 8)] # extract variables of interest
rm(data)
```

Next, we build an array and a multi-way contingency table
```{r, echo=FALSE}
covars <- ~ risks.time + risks.communication + risks.lackemployeecontrol + 
             risks.unclearPolicy + risks.workinghours + concern.stress
array <- xtabs(covars, data = mydata)
(flat <- ftable(array))
```

Visualize this arrangement using a doubledecker plot.
```{r, echo=FALSE}
orgFormula <- concern.stress ~ risks.time + risks.communication + risks.lackemployeecontrol + 
  risks.unclearPolicy +  risks.workinghours 
vcd::doubledecker(orgFormula, 
                  data = mydata, main = "Doubledecker plot of the data")
```

We also run a Cochran-Mantel-Haenstzl test to test for associations amongst the different elements of the above table and chart.
```{r, echo=FALSE}
vcdExtra::CMHtest(flat)                      # Cochran-Mantel-Haenszel test
```

**Modelling the data**
```{r, echo=FALSE}
ordered.fit <- polr(formula = orgFormula, data = mydata, Hess = TRUE)
table.coef <- coef(summary(ordered.fit))
# calculate and store p-values
pval <- pnorm(abs(table.coef[, "t value"]), lower.tail = FALSE) * 2
table.coef <- cbind(table.coef, "p-value" = pval)
table.coef
rm(table.coef, pval)
```


Calculate the Odds Ratio with 95% confidence intervals
```{r, echo=FALSE}
CI <- confint(ordered.fit)
odd.ratio <- exp(coef(ordered.fit))
# Tabulate O.R. and CI
odds.tabl <- cbind("O.R." = odd.ratio, exp(CI))
odds.tabl
```

Compare the fit with an intercept-only model
```{r, echo=FALSE}
nullmodel <- polr(concern.stress ~ 1, data = mydata, Hess = TRUE)
anova(nullmodel, ordered.fit)
```

Assessing the model
```{r, comment="##"}
# --- Evaluating the assumption of proportional odds ---
# A function to plot at class cut-off points
props <- function(y) {
  c('Y >= 1' = qlogis(mean(y >= 1)),
    'Y >= 2' = qlogis(mean(y >= 2)),
    'Y >= 3' = qlogis(mean(y >= 3)))
}

trial <- with(mydata,
               summary(as.numeric(concern.stress) ~ risks.time + 
                         risks.communication + risks.lackemployeecontrol + 
                         risks.unclearPolicy + risks.workinghours, fun = props))
trial
```

This step also checks the fit of the model by converting the outcome to binary variables at the respective class boundaries and fitting to the logistic regression model.
```{r}
# Treat outcome as a binary variable via "cut-off" points to test assumption
glm(I(as.numeric(concern.stress) >= 2) ~ risks.time + 
      risks.communication + risks.lackemployeecontrol + 
      risks.unclearPolicy + risks.workinghours, family = "binomial",
    data = mydata)

glm(I(as.numeric(concern.stress) >= 3) ~ risks.time + 
      risks.communication + risks.lackemployeecontrol + 
      risks.unclearPolicy + risks.workinghours, family = "binomial",
    data = mydata)
```

Tabulate and plot the logits
```{r, echo=TRUE}
trial[, 4] <- trial[, 4] - trial[, 3]
trial[, 3] <- trial[, 3] - trial[, 3]
trial

plot(trial, which = 1:3, pch = 1:3, xlab = "logit", main = "",
     xlim = range(trial[, 3:4]))
```

Predict the probabilites for the outcome variable
```{r}
# Create a dummy dataframe to predict probabilities
ks <- rep(c("Yes", "No"), 600)
data.pred <- data.frame(risks.time = ks,
                        risks.communication = ks,
                        risks.lackemployeecontrol = ks,
                        risks.unclearPolicy = ks,
                        risks.workinghours = ks)
data.pred <- cbind(data.pred, predict(ordered.fit, data.pred, type = "probs"))
head(data.pred)
```

We now rearrange the dataframe so that we have can plot the probabilities against the variables
```{r}
# Tidy the dataframe
data.pred <- data.pred %>%
  gather(category, probability, `No concern`:`Major concern`,
                factor_key = TRUE)
head(data.pred)
```

Now, plot the predicted probabilities 
```{r, echo=FALSE}
plot.new()
box()
```
**End**
